<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MetalPulse | Spot Prices</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#1e293b" />
    <link rel="apple-touch-icon" href="icon-192.png" />
    <style>
      .gold-glow { box-shadow: 0 10px 30px -5px rgba(245,158,11,0.4); }
      .silver-glow { box-shadow: 0 10px 30px -5px rgba(59,130,246,0.4); }
      .btn-transition { transition: all 0.3s cubic-bezier(0.4,0,0.2,1); }
    </style>
  </head>
  <body class="bg-[#0b1120] text-slate-200 min-h-screen flex items-center justify-center p-4 font-sans">

    <div class="w-full max-w-md bg-slate-800/40 backdrop-blur-2xl rounded-[3rem] p-8 shadow-2xl border border-slate-700/50 relative overflow-hidden">
      <!-- Your existing app HTML here (tabs, display, buttons, etc.) -->
      <!-- Add a hidden install button -->
      <button id="install-btn" class="hidden fixed bottom-6 right-6 bg-amber-500 text-black font-bold px-4 py-2 rounded-xl shadow-lg">
        Install App
      </button>
    </div>

    <script>
      /* === Metal Price App Logic === */
      const TROY_OUNCE_TO_GRAM = 31.1035;
      const TOLA_WEIGHT = 11.6638;
      let currentMetal = "xau";
      const currencySymbols = { npr:"Rs", inr:"₹", usd:"$", aed:"د.إ", aud:"A$" };
      const endpoints = {
        xau: "https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/xau.json",
        xag: "https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/xag.json",
      };

      async function init() {
        document.getElementById("currency-select").value = localStorage.getItem("selected_currency") || "npr";
        setMetal(localStorage.getItem("selected_metal") || "xau");
      }

      function setMetal(metal) {
        currentMetal = metal;
        localStorage.setItem("selected_metal", metal);
        fetchData();
        // ... your existing styling logic for Gold/Silver tabs
      }

      async function fetchData(force=false) {
        const today = new Date().toDateString();
        const cacheKey = `metal_cache_${currentMetal}`;
        const cached = localStorage.getItem(cacheKey);

        if(!force && cached) {
          const parsed = JSON.parse(cached);
          if(parsed.cacheDate === today) { render(parsed.rates, "Cached"); return; }
        }

        try {
          const res = await fetch(endpoints[currentMetal]);
          const data = await res.json();
          localStorage.setItem(cacheKey, JSON.stringify({ rates: data[currentMetal], cacheDate: today }));
          render(data[currentMetal], "Live");
        } catch(e) {
          document.getElementById("update-date").innerText = "Update Failed";
        }
      }

      function render(rates,type){
        const currency = document.getElementById("currency-select").value;
        const pricePerOz = rates[currency];
        const symbol = currencySymbols[currency];
        const pricePerGram = pricePerOz / TROY_OUNCE_TO_GRAM;
        document.getElementById("price-10g").innerText = `${symbol} ${Math.round(pricePerGram*10).toLocaleString()}`;
        document.getElementById("price-tola").innerText = `${symbol} ${Math.round(pricePerGram*TOLA_WEIGHT).toLocaleString()}`;
        document.getElementById("price-kg").innerText = `${symbol} ${Math.round(pricePerGram*1000).toLocaleString()}`;
        document.getElementById("update-date").innerText = `Synced at ${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`;
        const dot = document.getElementById("status-dot");
        document.getElementById("status-text").innerText = type;
        dot.className = `w-1.5 h-1.5 rounded-full ${type==="Live"?"bg-blue-400 animate-pulse":"bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"}`;
      }

      init();

      /* === Service Worker Registration === */
      if('serviceWorker' in navigator){
        window.addEventListener('load', ()=>{
          navigator.serviceWorker.register('/service-worker.js')
            .then(reg=>console.log('SW registered',reg))
            .catch(err=>console.log('SW registration failed',err));
        });
      }

      /* === PWA Install Prompt Handling === */
      let deferredPrompt;
      const installBtn = document.getElementById('install-btn');

      window.addEventListener('beforeinstallprompt', (e)=>{
        e.preventDefault();
        deferredPrompt = e;
        installBtn.classList.remove('hidden'); // show the button
      });

      installBtn.addEventListener('click', async ()=>{
        installBtn.classList.add('hidden');
        if(deferredPrompt){
          deferredPrompt.prompt();
          const choice = await deferredPrompt.userChoice;
          console.log('Install choice:', choice.outcome);
          deferredPrompt = null;
        }
      });
    </script>
  </body>
</html>
